<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Added PWA meta tags -->
  <meta name="theme-color" content="#0b74ff" />
  <meta name="description" content="Gerador de OS Medical Spin" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon.png" />
  <link rel="apple-touch-icon" href="/favicon.png" />
  <title>Gerador de OS - Medical Spin</title>

  <!-- CSS NOVO APLICADO -->
  <style>
    :root{
      --bg:#f8fafc;
      --surface:#ffffff;
      --muted:#6b7280;
      --accent:#0b74ff;
      --accent-600:#095fcc;
      --danger:#dc2626;
      --card-radius:12px;
      --input-radius:8px;
      --border:#e6e9ef;
      --glass:rgba(11,116,255,0.06);
      --shadow-1:0 6px 20px rgba(16,24,40,0.06);
      --shadow-2:0 2px 8px rgba(16,24,40,0.04);
      --font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial;
      --max-width:980px;
      --radius:12px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font-family);
      background:linear-gradient(180deg,var(--bg),#eef4ff 120px);
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.45;
      padding:24px 12px;
    }

    .container{max-width:var(--max-width);margin:0 auto;}

    .field-readonly {
      background: #f1f3f5 !important;
      color: #6b7280 !important;
      border-color: #d1d5db !important;
      cursor: not-allowed;
    }
    
    .field-readonly:focus {
      box-shadow: none !important;
    }

    /* T√≠tulos */
    h2 { margin-top:0; }

    /* caixas e estrutura */
    .section-title{font-size:15px;font-weight:700;color:#0f172a;margin-top:22px}
    .section-sub{font-size:13px;color:var(--muted);margin-bottom:12px}

    label{display:block;font-size:13px;margin-bottom:6px;color:#334155;font-weight:600}

    /* =========================
   AUTOCOMPLETE ‚Äì SUGEST√ïES
========================= */

#sugestoes {
  position: relative;
  margin-top: 6px;
  margin-bottom: 16px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #ffffff;
  box-shadow: 0 12px 30px rgba(16,24,40,0.12);
  max-height: 320px;
  overflow-y: auto;
}

/* categoria */
#sugestoes .categoria {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .04em;
  color: #64748b;
  padding: 10px 12px;
  background: #f8fafc;
  border-bottom: 1px solid #e5e7eb;
}

/* cliente */
.item-cliente {
  padding: 10px 12px;
  border-bottom: 1px solid #eef2f7;
}

.item-cliente:last-child {
  border-bottom: none;
}

.item-cliente > strong {
  font-size: 14px;
  color: #0f172a;
}

/* equipamentos */
.item-equipamento {
  margin-top: 6px;
  margin-left: 8px;
  padding: 8px 10px;
  border-radius: 8px;
  background: #f8fafc;
  border: 1px solid #e5e7eb;
  font-size: 13px;
  color: #334155;

  /* UX */
  cursor: pointer;
  transition: background .15s ease, border-color .15s ease, transform .05s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

/* hover claro */
.item-equipamento:hover {
  background: #eef4ff;
  border-color: var(--accent);
  transform: translateX(2px);
}

/* clique */
.item-equipamento:active {
  transform: translateX(0);
  background: #e0ecff;
}

/* √≠cone */
.item-equipamento::before {
  content: "üñ±Ô∏è";
  font-size: 14px;
}

/* scrollbar discreta */
#sugestoes::-webkit-scrollbar {
  width: 8px;
}

#sugestoes::-webkit-scrollbar-thumb {
  background: #d1d5db;
  border-radius: 4px;
}

#sugestoes::-webkit-scrollbar-thumb:hover {
  background: #9ca3af;
}

    .item-sugestao {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eef2f7;
      font-size: 14px;
    }
    .item-sugestao:hover { background-color: #f3f6fb; }

    .categoria {
      font-weight: 700;
      background: #f7f9ff;
      padding: 8px 10px;
      border-bottom: 1px solid #e1e6ef;
      font-size: 13px;
      color: var(--muted);
    }

    /* inputs */
    input[type=text], input[type=tel], input[type=date], select, textarea {
      width: 100%;
      padding: 11px 12px;
      border-radius: var(--input-radius);
      border: 1px solid var(--border);
      background: linear-gradient(180deg,#ffffff,#fbfdff);
      font-size: 14px;
      color: #0f172a;
      transition: box-shadow .16s ease,border-color .16s ease,transform .04s ease;
      outline: none;
    }
    textarea{min-height:96px;resize:vertical}

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 8px 30px rgba(11,116,255,0.08), 0 0 0 4px var(--glass);
    }

    /* grid */
    .grid{display:grid;gap:12px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:780px){.cols-3{grid-template-columns:1fr}}
    @media (max-width:600px){.cols-2{grid-template-columns:1fr}}

    /* repeat lists */
    .repeat-list{
      border-radius:10px;padding:10px;border:1px dashed var(--border);background:#fbfdff
    }

    .repeat-item{
      padding:12px;
      border-radius:10px;
      background:linear-gradient(180deg,#fff,#fbfdff);
      border:1px solid #eef2f7;
      box-shadow:var(--shadow-2);
      margin-bottom:10px;
      display:grid;gap:8px
    }

    .required{color:var(--danger);font-weight:800;margin-left:6px}

    /* a√ß√µes */
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:20px}

    button{
      border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;
      background:var(--accent);color:#fff;
      box-shadow:0 6px 18px rgba(11,116,255,0.12);
      transition:transform .12s ease, box-shadow .12s ease, background .12s;
    }
    button:hover{transform:translateY(-2px)}
    button:active{transform:translateY(0)}

    .btn-ghost{
      background:transparent;color:var(--accent);
      border:1px solid rgba(11,116,255,0.18);
      box-shadow:none
    }
    .btn-ghost:hover{background:rgba(11,116,255,0.04)}

    /* small tweaks for suggestion box appended to body */
    #suggestionBox { position: absolute; background: #fff; border: 1px solid #ccc; border-radius:6px; box-shadow: var(--shadow-2); z-index: 10000; }
    
    /* success animation styles */
    .success-animation {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: white;
      padding: 40px;
      border-radius: var(--radius);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 10001;
      display: none;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 16px;
    }

    .success-animation.show {
      display: flex;
      animation: successPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
    }

    @keyframes successPop {
      0% {
        transform: translate(-50%, -50%) scale(0) rotate(-180deg);
        opacity: 0;
      }
      100% {
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    .success-animation .checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: white;
      animation: pulse 0.6s ease;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .success-animation h3 {
      margin: 0;
      font-size: 24px;
      color: #0f172a;
    }

    .success-animation p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }
  </style>
</head>

<body>

<script src="https://unpkg.com/heic2any/dist/heic2any.min.js"></script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('[v0] Service Worker registered'))
      .catch(err => console.log('[v0] Service Worker registration failed:', err));
  });
}
</script>

<form id="osForm"><!-- necess√°rio para FormData funcionar -->
  <div class="container">
    <h2>Gerador de OS V1.0.0</h2>
    <p>Digite para buscar em todos os campos da base e receber sugest√µes detalhadas.</p>
    <p>N√£o encontrou a sugest√£o do cliente?  
    <a href="https://n8n-www4kggggc4c8k8ow4w8g4g0.95.217.164.173.sslip.io/webhook/cadastra-cliente" target="_blank" rel="noopener noreferrer">
        Cadastre o cliente clicando aqui
    </a>
    </p>

    <label>Buscar cliente</label>
    <input type="text" id="busca" placeholder="Digite algo..." autocomplete="off" />

    <div id="sugestoes"></div>

    <div>
      <div class="section-title">1 ‚Äî Dados da Empresa</div>
      <div class="section-sub">Informa√ß√µes b√°sicas do cliente</div>
    </div>

    <!-- CAMPOS AUTOM√ÅTICOS (READONLY) -->
    <label class="label">Raz√£o Social</label>
    <input type="text" id="razao_social" name="razao_social" readonly class="field-readonly" />

    <label class="label">Nome Fantasia</label>
    <input type="text" id="nome_fantasia" name="nome_fantasia" readonly class="field-readonly" />

    <label class="label">CNPJ</label>
    <input type="text" id="cnpj" name="cnpj" readonly class="field-readonly" />

    <label class="label">Cidade</label>
    <input type="text" id="cidade" name="cidade" readonly class="field-readonly" />

    <label class="label">UF</label>
    <input type="text" id="uf" name="uf" readonly class="field-readonly" />

    <label class="label">Telefone</label>
    <input type="text" id="telefone" name="telefone" readonly class="field-readonly" />

    <label class="label">Email</label>
    <input type="text" id="email" name="email" readonly class="field-readonly" />

    <label class="label">Respons√°vel</label>
    <input type="text" id="responsavel" name="responsavel" readonly class="field-readonly" />

    <div>
      <div class="section-title">2 ‚Äî Dados do Equipamento</div>
      <div class="section-sub">Identifica√ß√£o do equipamento</div>
    </div>

    <label class="label">Tipo de Equipamento</label>
    <input type="text" id="tipo_equipamento" name="tipo_equipamento" readonly class="field-readonly" />

    <label class="label">Fabricante</label>
    <input type="text" id="fabricante" name="fabricante" readonly class="field-readonly" />

    <label class="label">Modelo</label>
    <input type="text" id="modelo" name="modelo" readonly class="field-readonly" />

    <label class="label">N√∫mero de S√©rie</label>
    <input type="text" id="serie" name="serie" readonly class="field-readonly" />

    <div class="section-header">
      <div class="section-title">3 ‚Äî Motivo e Eventos</div>
    </div>

    <label>
      Motiva√ß√£o do Servi√ßo <span class="required">*</span>
    </label>
    <textarea id="motivacao" name="motivacao" class="field" required></textarea>

    <div style="margin-top:10px">
      <label>Eventos Relevantes</label>
      <textarea id="eventos" name="eventos" class="field"></textarea>
    </div>

    <div class="section-header">
      <div class="section-title">4 ‚Äî Tipo de Interven√ß√£o</div>
    </div>

    <label>Tipo</label>
    <select id="tipo_intervencao" name="tipo_intervencao" class="field" required>
      <option>Manuten√ß√£o Corretiva</option>
      <option>Manuten√ß√£o Preventiva</option>
      <option>Visita T√©cnica</option>
      <option>Outro</option>
    </select>

    <div style="margin-top:10px">
      <label>Descri√ß√£o dos Servi√ßos Realizados</label>
      <textarea id="descricao_servicos" name="descricao_servicos" class="field" required></textarea>
    </div>

    <div class="section-header">
      <div>
        <div class="section-title">5 ‚Äî Pe√ßas</div>
        <div class="section-sub">Registre pe√ßas por categoria</div>
      </div>
    </div>

    <div style="margin-bottom:8px">
      <div style="font-weight:700;margin-bottom:6px">Partes removidas ‚Äî Posse do cliente</div>

      <div id="pecas_cliente" class="repeat-list"></div>

      <div style="margin-top:8px">
        <button type="button" class="btn-ghost" onclick="addPeca('cliente')">+ Adicionar</button>
      </div>
    </div>

    <div style="margin-top:12px;margin-bottom:8px">
      <div style="font-weight:700;margin-bottom:6px">Partes removidas ‚Äî Posse da Medical Spin</div>

      <div id="pecas_ms" class="repeat-list"></div>

      <div style="margin-top:8px">
        <button type="button" class="btn-ghost" onclick="addPeca('ms')">+ Adicionar</button>
      </div>
    </div>

    <div class="section-header">
      <div class="section-title">6 ‚Äî M√£o de Obra</div>
    </div>

    <div id="horas_list" class="repeat-list" required></div>

    <div style="margin-top:8px">
      <button type="button" class="btn-ghost" onclick="addHoras()">+ Adicionar dia</button>
    </div>

    <div class="section-header">
      <div class="section-title">7 ‚Äî Pend√™ncias</div>
    </div>

    <label>Pend√™ncias da Medical Spin</label>
    <textarea id="pendencias_ms" name="pendencias_ms" class="field"></textarea>

    <div style="margin-top:10px">
      <label>Pend√™ncias do Cliente</label>
      <textarea id="pendencias_cliente" name="pendencias_cliente" class="field"></textarea>
    </div>

    <div class="section-header">
      <div class="section-title">8 ‚Äî Estado do Equipamento</div>
    </div>

    <div class="grid cols-2">
      <div>
        <label>Estado Inicial</label>
        <select id="estado_inicial" name="estado_inicial" class="field">
          <option>Funcional</option>
          <option>Parcialmente Funcional</option>
          <option>Inoperante</option>
        </select>
      </div>

      <div>
        <label>Estado Final</label>
        <select id="estado_final" name="estado_final" class="field" onchange="onEstadoFinalChange()">
          <option>Funcional</option>
          <option>Parcialmente Funcional</option>
          <option>Inoperante</option>
        </select>
      </div>
    </div>

    <div id="motivo_restricao" style="display:none;margin-top:10px">
      <label>Motivo da Restri√ß√£o</label>
      <textarea id="motivo_restricao_text" class="field"></textarea>
    </div>

    <div id="motivo_inoperante" style="display:none;margin-top:10px">
      <label>Motivo da Inoper√¢ncia</label>
      <textarea id="motivo_inoperante_text" class="field"></textarea>
    </div>

    <div class="section-header">
      <div class="section-title">9 ‚Äî Local e Assinaturas</div>
    </div>

    <div class="grid cols-2">
      <div>
        <label class="label">Cidade</label>
        <input type="text" id="cidade_assinatura" name="cidade_assinatura" readonly class="field-readonly" />
      </div>

      <div>
        <label class="label">UF</label>
        <input type="text" id="uf_assinatura" name="uf_assinatura" readonly class="field-readonly" />
      </div>
    </div>

    <div style="margin-top:10px" class="grid cols-2">
      <div>
        <label>Nome do Engenheiro</label>
        <input id="nome_tecnico" name="nome_tecnico" class="field" type="text"
               value="JULIO CESAR RODRIGUES" />
      </div>

      <div>
        <label>CFT do Engenheiro</label>
        <input id="cft_tecnico" name="cft_tecnico" class="field compact" type="text"
               value="2000103820" />
      </div>
    </div>

    <div style="margin-top:10px" class="grid cols-2">
      <div>
        <label class="label">Nome do Recebedor</label>
        <input type="text" id="responsavel_assinatura" name="responsavel_assinatura" class="field" />
      </div>
    </div>

    <section class="section">
      <div class="section-header">
        <div class="section-title">Envio de M√≠dias</div>
      </div>

      <input type="file" id="midias" name="midias" multiple
             accept="image/*,video/*,.pdf,.doc,.docx,.xlsx,.zip" />
    </section>

    <!-- actions -->
    <div class="actions" style="margin-top:6px">
      <button type="button" onclick="sendToWebhook(event)">Gerar OS</button>
      <button type="button" class="btn-ghost" onclick="resetForm()">Limpar</button>
    </div>

  </div> <!-- /container -->

</form> <!-- /osForm -->

<!-- success animation overlay -->
<div class="success-animation" id="successAnimation">
  <div class="checkmark">‚úì</div>
  <h3>Sucesso!</h3>
  <p id="successMessage">Opera√ß√£o conclu√≠da com sucesso</p>
</div>

<!-- resultado (fora do form) -->
<div id="result" style="display:none">
  <div class="card" style="margin-top:14px">
    <h3 style="margin:0 0 10px 0">Sa√≠da (JSON)</h3>
    <pre id="jsonOut" style="white-space:pre-wrap;max-height:360px;overflow:auto"></pre>
  </div>
</div>

<!-- campos "auxiliares" necess√°rios para compatibilidade com seus scripts -->
<!-- n√£o vis√≠veis para o usu√°rio 
<input type="hidden" id="cidade" />
<input type="hidden" id="uf" />
<input type="hidden" id="responsavel" />-->

<script>
  const input = document.getElementById("busca");
  const boxSugestoes = document.getElementById("sugestoes");

  const campos = {
    razao_social: document.getElementById("razao_social"),
    nome_fantasia: document.getElementById("nome_fantasia"),
    cnpj: document.getElementById("cnpj"),
    cidade: document.getElementById("cidade"),
    uf: document.getElementById("uf"),
    telefone: document.getElementById("telefone"),
    email: document.getElementById("email"),
    responsavel: document.getElementById("responsavel"),

    // se√ß√£o 9
    cidade_assinatura: document.getElementById("cidade_assinatura"),
    uf_assinatura: document.getElementById("uf_assinatura"),
    responsavel_assinatura: document.getElementById("responsavel_assinatura"),

    tipo_equipamento: document.getElementById("tipo_equipamento"),
    fabricante: document.getElementById("fabricante"),
    modelo: document.getElementById("modelo"),
    serie: document.getElementById("serie")
  };

  input.addEventListener("input", async (e) => {
    const termo = e.target.value.trim().toLowerCase();

    if (termo.length < 2) {
      boxSugestoes.innerHTML = "";
      return;
    }

    try {
      const res = await fetch(
        "https://n8n-www4kggggc4c8k8ow4w8g4g0.95.217.164.173.sslip.io/webhook/autocomplete-busca",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ termo })
        }
      );

      const data = await res.json();
      const listaBruta = data.resultados || [];

const lista = listaBruta
  .map(cliente => {
    const termoMatchCliente =
      `${cliente.razao_social} ${cliente.nome_fantasia} ${cliente.cnpj}`
        .toLowerCase()
        .includes(termo);

    const equipamentosFiltrados = (cliente.equipamentos || []).filter(eq =>
      `${eq.tipo_equipamento} ${eq.fabricante} ${eq.modelo} ${eq.serie}`
        .toLowerCase()
        .includes(termo)
    );

    // s√≥ retorna cliente se ele ou algum equipamento casar
    if (!termoMatchCliente && equipamentosFiltrados.length === 0) {
      return null;
    }

    return {
      ...cliente,
      equipamentos: equipamentosFiltrados.length
        ? equipamentosFiltrados
        : cliente.equipamentos
    };
  })
  .filter(Boolean);


      if (!lista.length) {
  boxSugestoes.innerHTML = `
    <div class="item-sugestao" style="cursor:default">
      <strong>Nenhum cliente encontrado</strong><br>
      <small>
        N√£o encontrou o cliente?
        <a href="https://n8n-www4kggggc4c8k8ow4w8g4g0.95.217.164.173.sslip.io/webhook/cadastra-cliente"
           target="_blank" rel="noopener noreferrer"
           style="color:#0b74ff;font-weight:700">
          Clique aqui para cadastrar
        </a>
      </small>
    </div>
  `;
  return;
}

      let html = `<div class="categoria">Clientes encontrados</div>`;

      lista.forEach(cliente => {
        html += `
          <div class="item-cliente">
            <strong>${cliente.razao_social}</strong><br>
            <small>${cliente.cnpj} ‚Äî ${cliente.cidade}/${cliente.uf}</small>
        `;

        (cliente.equipamentos || []).forEach(eq => {
          html += `
            <div class="item-equipamento"
              data-cliente='${JSON.stringify(cliente)}'
              data-equipamento='${JSON.stringify(eq)}'>
              üîß ${eq.tipo_equipamento} ‚Äî ${eq.fabricante} ${eq.modelo} (${eq.serie})
            </div>
          `;
        });

        html += `</div>`;
      });

      boxSugestoes.innerHTML = html;

      document.querySelectorAll(".item-equipamento").forEach(el => {
        el.onclick = () => {
          const cliente = JSON.parse(el.dataset.cliente);
          const eq = JSON.parse(el.dataset.equipamento);

          input.value = cliente.razao_social || "";

          campos.razao_social.value = cliente.razao_social || "";
          campos.nome_fantasia.value = cliente.nome_fantasia || "";
          campos.cnpj.value = cliente.cnpj || "";
          campos.cidade.value = cliente.cidade || "";
          campos.uf.value = cliente.uf || "";
          campos.telefone.value = cliente.telefone || "";
          campos.email.value = cliente.email || "";
          campos.responsavel.value = cliente.responsavel || "";

          // se√ß√£o 9
          campos.cidade_assinatura.value = cliente.cidade || "";
          campos.uf_assinatura.value = cliente.uf || "";
          campos.responsavel_assinatura.value = cliente.responsavel || "";

          campos.tipo_equipamento.value = eq.tipo_equipamento || "";
          campos.fabricante.value = eq.fabricante || "";
          campos.modelo.value = eq.modelo || "";
          campos.serie.value = eq.serie || "";

          // compatibilidade com outros scripts
          ///const cidadeEmp = document.getElementById("cidade_empresa");
          //const ufEmp = document.getElementById("uf_empresa");
          //const recebedor = document.getElementById("recebedor");

          //if (cidadeEmp) cidadeEmp.value = cliente.cidade || "";
         // if (ufEmp) ufEmp.value = cliente.uf || "";
          //if (recebedor) recebedor.value = cliente.responsavel || "";

          boxSugestoes.innerHTML = "";
        };
      });

    } catch (err) {
      console.error("Erro no autocomplete:", err);
    }
  });
</script>

<script>
  /* same JS logic from your original file, unchanged. Keep the dynamic pieces below */

  function addPeca(tipo) {
    const mapa = {
      cliente: "pecas_cliente",
      ms: "pecas_ms",
      reparadas: "pecas_reparadas",
      inseridas: "pecas_inseridas"
    };

    const container = document.getElementById(mapa[tipo]);
    const item = document.createElement("div");
    item.className = "repeat-item";

    item.innerHTML = `
      <label>Nome da pe√ßa</label>
      <input class="peca_nome" type="text">

      <label>Modelo / Ref</label>
      <input class="peca_modelo" type="text">

      <label>N¬∫ de S√©rie</label>
      <input class="peca_sn" type="text">

      <label>Observa√ß√µes</label>
      <input class="peca_destino" type="text">

      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button type="button" class="btn-ghost"
          style="background:transparent;color:#ef4444;border:1px solid rgba(239,68,68,0.06);">
          Remover
        </button>
      </div>
    `;

    item.querySelector("button").onclick = () => container.removeChild(item);
    container.appendChild(item);
  }

  function addHoras() {
    const c = document.getElementById("horas_list");
    const item = document.createElement("div");
    item.className = "repeat-item";

    item.innerHTML = `
      <div class="grid cols-3">
        <div>
          <label>Data</label>
          <input class="hh_data" type="date">
        </div>

        <div>
          <label>HH efetivo</label>
          <input class="hh_efetivo" type="text">
        </div>

        <div>
          <label>HH contingencial</label>
          <input class="hh_contingencial" type="text">
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;margin-top:6px">
        <button type="button" class="btn-ghost"
          style="background:transparent;color:#ef4444;border:1px solid rgba(239,68,68,0.06);">
          Remover
        </button>
      </div>
    `;

    item.querySelector("button").onclick = () => c.removeChild(item);
    c.appendChild(item);
  }

  function onEstadoFinalChange() {
    const v = document.getElementById("estado_final").value;

    document.getElementById("motivo_restricao").style.display =
      v === "Parcialmente Funcional" ? "block" : "none";

    document.getElementById("motivo_inoperante").style.display =
      v === "Inoperante" ? "block" : "none";
  }

  function gatherForm() {
    const data = {};
    const f = new FormData(document.getElementById("osForm"));

    for (const [k, v] of f.entries()) {
      if (k !== "midias") data[k] = v;
    }

    data["pecas_cliente"] = coletaPecas("pecas_cliente");
    data["pecas_ms"] = coletaPecas("pecas_ms");
    data["mao_de_obra"] = coletaHoras();

    data["motivo_restricao"] =
      document.getElementById("motivo_restricao_text").value || "";
    data["motivo_inoperante"] =
      document.getElementById("motivo_inoperante_text").value || "";

    return data;
  }

  function coletaPecas(id) {
    const out = [];

    document.querySelectorAll(`#${id} .repeat-item`).forEach(it => {
      out.push({
        nome: it.querySelector(".peca_nome").value,
        modelo: it.querySelector(".peca_modelo").value,
        sn: it.querySelector(".peca_sn").value,
        detalhes: it.querySelector(".peca_destino").value
      });
    });

    return out;
  }

  function coletaHoras() {
    const out = [];

    document.querySelectorAll("#horas_list .repeat-item").forEach(it => {
      out.push({
        data: it.querySelector(".hh_data").value,
        hh_efetivo: it.querySelector(".hh_efetivo").value,
        hh_contingencial: it.querySelector(".hh_contingencial").value
      });
    });

    return out;
  }

  async function filesToBase64(fileList) {
  const promises = [];

  for (let i = 0; i < fileList.length; i++) {
    const file = fileList[i];

    // === HEIC / HEIF ===
    if (file.type === "image/heic" || file.type === "image/heif") {
      promises.push(
        (async () => {
          const jpegBlob = await heic2any({
            blob: file,
            toType: "image/jpeg",
            quality: 0.9
          });

          const base64 = await blobToBase64(jpegBlob);

          return {
            nome: file.name.replace(/\.[^/.]+$/, "") + ".jpg",
            tipo: "image/jpeg",
            tamanho: jpegBlob.size,
            base64
          };
        })()
      );
      continue;
    }

    // === OUTRAS IMAGENS ===
    if (file.type.startsWith("image/")) {
      promises.push(convertImageToJpeg(file));
      continue;
    }

    // === N√ÉO IMAGEM ===
    promises.push(readFileAsBase64(file));
  }

  return Promise.all(promises);
}

function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onerror = () => reject("Erro ao ler arquivo");

    reader.onload = () => {
      resolve({
        nome: file.name,
        tipo: file.type,
        tamanho: file.size,
        base64: reader.result.split(",")[1]
      });
    };

    reader.readAsDataURL(file);
  });
}

function convertImageToJpeg(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = () => {
      const img = new Image();

      img.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;

        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);

        const jpegBase64 = canvas
          .toDataURL("image/jpeg", 0.9)
          .split(",")[1];

        resolve({
          nome: file.name.replace(/\.[^/.]+$/, "") + ".jpg",
          tipo: "image/jpeg",
          tamanho: jpegBase64.length,
          base64: jpegBase64
        });
      };

      img.onerror = () => reject("Imagem n√£o suportada");
      img.src = reader.result;
    };

    reader.readAsDataURL(file);
  });
}

function blobToBase64(blob) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.readAsDataURL(blob);
  });
}




  function generateJSON(formElement) {
  const formData = new FormData(formElement);

  // coleta campos normais
  const payload = {};
  for (const [key, value] of formData.entries()) {
    payload[key] = value || "N/A";
  }

  // coleta pe√ßas
  payload.pecas_cliente = coletaPecas("pecas_cliente");
  payload.pecas_ms = coletaPecas("pecas_ms");

  // coleta horas
  payload.mao_de_obra = coletaHoras();

  return payload;
}


  function resetForm() {
    const form = document.getElementById("osForm");

    // reset padr√£o do form
    form.reset();

    // limpa campos readonly/autocomplete
    const camposLimpar = [
      "busca",
      "razao_social",
      "nome_fantasia",
      "cnpj",
      "cidade",
      "uf",
      "telefone",
      "email",
      "responsavel",
      "cidade_assinatura",
      "uf_assinatura",
      "responsavel_assinatura",
      "tipo_equipamento",
      "fabricante",
      "modelo",
      "serie"
    ];

    camposLimpar.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });

    // limpa listas din√¢micas
    [
      "pecas_cliente",
      "pecas_ms",
      "pecas_reparadas",
      "pecas_inseridas",
      "horas_list"
    ].forEach(id => {
      const c = document.getElementById(id);
      if (c) c.innerHTML = "";
    });

    // esconde condicionais
    document.getElementById("motivo_restricao").style.display = "none";
    document.getElementById("motivo_inoperante").style.display = "none";
    document.getElementById("motivo_restricao_text").value = "";
    document.getElementById("motivo_inoperante_text").value = "";

    // limpa upload de arquivos
    const midias = document.getElementById("midias");
    if (midias) midias.value = "";

    // restaura VALORES PADR√ïES
    document.getElementById("nome_tecnico").value =
      "JULIO CESAR RODRIGUES";
    document.getElementById("cft_tecnico").value =
      "2000103820";

    // selects voltam para o primeiro item
    document.getElementById("tipo_intervencao").selectedIndex = 0;
    document.getElementById("estado_inicial").selectedIndex = 0;
    document.getElementById("estado_final").selectedIndex = 0;

    // limpa sugest√µes
    document.getElementById("sugestoes").innerHTML = "";

    // esconde resultado
    document.getElementById("result").style.display = "none";
  }

  async function sendToWebhook(event) {
  event.preventDefault();

  const form = document.getElementById("osForm");
  const jsonPayload = generateJSON(form);

  const inputMidias = document.getElementById("midias");
  const arquivos = inputMidias.files;

  let midiasBase64 = [];

  if (arquivos && arquivos.length > 0) {
    midiasBase64 = await filesToBase64(arquivos);
  }

  jsonPayload.midias = midiasBase64;

  await fetch(
    "https://n8n-www4kggggc4c8k8ow4w8g4g0.95.217.164.173.sslip.io/webhook/recebe-dados-os",
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(jsonPayload)
    }
  );

  showSuccessAnimation("OS gerada com sucesso!");

  // LIMPA TUDO E MANT√âM OS PADR√ïES
  resetForm();
}

  // success animation function
  function showSuccessAnimation(message) {
    const animation = document.getElementById('successAnimation');
    const messageEl = document.getElementById('successMessage');
    messageEl.textContent = message;
    animation.classList.add('show');
    
    setTimeout(() => {
      animation.classList.remove('show');
    }, 3000);
  }
</script>

<script>
  // Adaptado para usar #razao ou, se n√£o existir, #busca (compatibilidade).
  const inputRazao = document.getElementById("razao") || document.getElementById("busca");
  let timeout = null;

  if (inputRazao) {
    inputRazao.addEventListener("input", function () {
      const q = this.value.trim();
      if (q.length < 2) return;

      clearTimeout(timeout);

      timeout = setTimeout(() => {
        fetch(
          `https://n8n-www4kggggc4c8k8ow4w8g4g0.95.217.164.173.sslip.io/webhook/auto-complete?q=${encodeURIComponent(
            q
          )}`
        )
          .then(r => r.json())
          .then(data => showSuggestions(data.suggestions))
          .catch(err => console.error(err));
      }, 250);
    });
  }

  function showSuggestions(list) {
    removeSuggestionBox();

    const box = document.createElement("div");
    box.id = "suggestionBox";
    box.style.position = "absolute";
    box.style.background = "#fff";
    box.style.border = "1px solid #ccc";
    box.style.width = (inputRazao && inputRazao.offsetWidth) ? inputRazao.offsetWidth + "px" : "300px";
    box.style.zIndex = 1000;

    list.forEach(item => {
      const opt = document.createElement("div");
      opt.textContent = `${item.razao} (${item.cnpj || ""})`;
      opt.style.padding = "8px";
      opt.style.cursor = "pointer";

      opt.onclick = () => {
        // Preenchimento r√°pido baseado no payload dessa autocomplete (padr√£o)
        //if (inputRazao) inputRazao.value = item.razao || "";
        //const elCnpj = document.getElementById("cnpj");
        //if (elCnpj) elCnpj.value = item.cnpj || "";
        //const elCidade = document.getElementById("cidade");
        //if (elCidade) elCidade.value = item.cidade || "";
        //const elUf = document.getElementById("uf_empresa");
        //if (elUf) elUf.value = item.uf || "";
        //const elSolic = document.getElementById("recebedor");
        //if (elSolic) elSolic.value = item.responsavel || "";

        removeSuggestionBox();
      };

      box.appendChild(opt);
    });

    // append near the input if possible, otherwise to body
    if (inputRazao && inputRazao.parentNode) {
      inputRazao.parentNode.appendChild(box);
    } else {
      document.body.appendChild(box);
    }
  }

  function removeSuggestionBox() {
    const old = document.getElementById("suggestionBox");
    if (old) old.remove();
  }

  document.addEventListener("click", e => {
    if (e.target.id !== "suggestionBox") removeSuggestionBox();
  });
</script>


</body>
</html>
