<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0b74ff" />
  <meta name="description" content="Sistema de gest√£o de clientes e equipamentos Medical Spin" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon.png" />
  <link rel="apple-touch-icon" href="/favicon.png" />
  <title>Medical Spin - Dashboard</title>
  <!-- Added Chart.js CDN for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

  <style>
    :root {
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --surface: #ffffff;
      --surface-hover: #f1f5f9;
      --border: #e2e8f0;
      --border-focus: #0b74ff;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --accent: #0b74ff;
      --accent-hover: #0860d9;
      --accent-light: #eff6ff;
      --secondary: #64748b;
      --secondary-hover: #475569;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --success: #10b981;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --radius-sm: 8px;
      --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      /* Added color variables for stats cards */
      --clientes-color: #0b74ff;
      --clientes-bg: linear-gradient(135deg, #0b74ff 0%, #3b82f6 100%);
      --os-color: #10b981;
      --os-bg: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-sans);
      background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
      min-height: 100vh;
      padding: 24px;
      margin: 0;
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
    }

    h1 {
      margin: 0 0 24px 0;
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    h1::before {
      content: 'üè•';
      font-size: 32px;
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    /* Updated styles for stats grid - 2 cards on top */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow-lg);
      border: none;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient);
    }

    .stat-card.clientes::before {
      background: var(--clientes-bg);
    }

    .stat-card.os::before {
      background: var(--os-bg);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .stat-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: var(--icon-bg);
    }

    .stat-card.clientes .stat-icon {
      background: linear-gradient(135deg, rgba(11, 116, 255, 0.1) 0%, rgba(59, 130, 246, 0.15) 100%);
    }

    .stat-card.os .stat-icon {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.15) 100%);
    }

    .stat-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 48px;
      font-weight: 700;
      color: var(--value-color);
      line-height: 1;
      margin: 8px 0;
    }

    .stat-card.clientes .stat-value {
      color: var(--clientes-color);
    }

    .stat-card.os .stat-value {
      color: var(--os-color);
    }

    .stat-description {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* Updated charts grid for bottom section */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .chart-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .chart-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .chart-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chart-container {
      position: relative;
      height: 280px;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 10px;
      margin-bottom: 6px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    input {
      width: 100%;
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      border: 2px solid var(--border);
      font-size: 16px;
      transition: all 0.2s ease;
      background: var(--surface);
      color: var(--text-primary);
    }

    input:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(11, 116, 255, 0.1);
    }

    button {
      padding: 12px 20px;
      border: none;
      border-radius: var(--radius-sm);
      background: var(--accent);
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    button:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--secondary);
    }

    .btn-secondary:hover {
      background: var(--secondary-hover);
    }

    .muted {
      color: var(--text-muted);
      font-size: 14px;
    }

    ul {
      padding-left: 20px;
      margin: 12px 0;
    }

    ul li {
      margin: 6px 0;
      color: var(--text-secondary);
    }

    .cliente-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      gap: 12px;
      padding: 12px;
      border-radius: var(--radius-sm);
      transition: background 0.2s ease;
    }

    .cliente-header:hover {
      background: var(--surface-hover);
    }

    .cliente-body {
      display: none;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 2px solid var(--border);
    }

    .card.ativo .cliente-body {
      display: block;
    }

    .card.ativo {
      border-left: 4px solid var(--accent);
      background: linear-gradient(to right, var(--accent-light) 0%, var(--surface) 10%);
    }

    #modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    #modal .modal-content {
      background: var(--surface);
      border-radius: var(--radius);
      width: 100%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 24px;
      box-shadow: var(--shadow-lg);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .busca-actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    /* ===== INSTALL BANNER (FIX DEFINITIVO MOBILE) ===== */

.install-banner {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;

  background: linear-gradient(135deg, var(--accent) 0%, #0860d9 100%);
  color: white;

  padding: 16px 16px calc(16px + env(safe-area-inset-bottom));

  box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
  z-index: 10000;

  display: flex;
  flex-direction: column;
  gap: 12px;

  align-items: stretch;
  text-align: center;

  transform: translateY(120%);
  transition: transform 0.35s ease;
  will-change: transform;
}

.install-banner.show {
  transform: translateY(0);
}


    .install-banner h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .install-banner p {
      margin: 0;
      font-size: 14px;
      opacity: 0.95;
    }

    .install-banner-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
  width: 100%;
}

.install-banner-actions button {
  width: 100%;
  padding: 12px;
  font-size: 15px;
}


    .install-banner .btn-install {
      background: white;
      color: var(--accent);
    }

    .install-banner .btn-dismiss {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    /* ===== FIX BANNER PWA MOBILE ===== */

.install-banner {
  max-width: 100%;
  box-sizing: border-box;
  padding-bottom: env(safe-area-inset-bottom);
}

@media (max-height: 600px) {
  .install-banner h3 {
    font-size: 15px;
  }

  .install-banner p {
    font-size: 13px;
    line-height: 1.3;
  }
}



    .success-animation {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: white;
      padding: 40px;
      border-radius: var(--radius);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 10001;
      display: none;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 16px;
    }

    .success-animation.show {
      display: flex;
      animation: successPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
    }

    @keyframes successPop {
      0% {
        transform: translate(-50%, -50%) scale(0) rotate(-180deg);
        opacity: 0;
      }
      100% {
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    .success-animation .checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--success);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      animation: pulse 0.6s ease;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .success-animation h3 {
      margin: 0;
      font-size: 24px;
      color: var(--text-primary);
    }

    .success-animation p {
      margin: 0;
      color: var(--text-secondary);
      font-size: 14px;
    }

    @media (max-width: 600px) {
      body {
        padding: 16px;
      }

      h1 {
        font-size: 24px;
      }

      .header-actions {
        flex-direction: column;
        width: 100%;
      }

      .header-actions button {
        width: 100%;
      }

      .cliente-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .install-banner {
        padding: 16px;
      }

      .install-banner h3 {
        font-size: 16px;
      }

      .install-banner-actions {
        flex-direction: column;
        width: 100%;
      }

      .install-banner-actions button {
        width: 100%;
      }

      /* Responsive adjustments for mobile */
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .stat-value {
        font-size: 40px;
      }

      .charts-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .chart-container {
        height: 220px;
      }
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .loading::after {
      content: '.';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    /* ===== FIX RESPONSIVIDADE GR√ÅFICOS ===== */

/* Garante que o canvas nunca estoure o card */
.chart-container {
  width: 100%;
  max-width: 100%;
  overflow: hidden;
}

.chart-container canvas {
  width: 100% !important;
  max-width: 100% !important;
  height: 100% !important;
  display: block;
}

/* Evita quebra horizontal em telas pequenas */
.charts-grid {
  width: 100%;
  max-width: 100%;
}

/* Mobile real (at√© 480px) */
@media (max-width: 480px) {
  .charts-grid {
    grid-template-columns: 1fr;
  }

  .chart-card {
    padding: 16px;
  }

  .chart-title {
    font-size: 16px;
    flex-wrap: wrap;
    line-height: 1.3;
  }

  .chart-container {
    height: 200px;
  }
}

  </style>
</head>

<body>

<h1>Dashboard Medical Spin</h1>

<!-- New stats cards layout - Total Clientes and Total OS on top -->
<div class="stats-grid">
  <div class="stat-card clientes">
    <div class="stat-card-header">
      <div class="stat-icon">üë•</div>
      <div class="stat-label">Total de Clientes</div>
    </div>
    <div class="stat-value" id="totalClientes">-</div>
    <div class="stat-description">Clientes cadastrados no sistema</div>
  </div>

  <div class="stat-card os">
    <div class="stat-card-header">
      <div class="stat-icon">üìã</div>
      <div class="stat-label">Total de OS</div>
    </div>
    <div class="stat-value" id="totalOS">-</div>
    <div class="stat-description">Ordens de servi√ßo geradas</div>
  </div>
</div>

<!-- Charts section below - Clientes chart and Clientes por Estado -->
<div class="charts-grid">
  <div class="chart-card">
    <div class="chart-title">üìä Distribui√ß√£o de Clientes/Equipamentos</div>
    <div class="chart-container">
      <canvas id="chartClientes"></canvas>
    </div>
  </div>

  <div class="chart-card">
    <div class="chart-title">üó∫Ô∏è Clientes por Estado</div>
    <div class="chart-container">
      <canvas id="chartEstados"></canvas>
    </div>
  </div>
</div>

<div class="card" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
  <strong style="font-size: 16px; color: var(--text-primary);">Gerenciamento de Clientes</strong>
  
  <div class="header-actions">
    <button class="btn-secondary" onclick="historicoOs()">üìã Hist√≥rico de OS</button>
    <button onclick="adicionarCliente()">‚ûï Adicionar Cliente</button>
  </div>
</div>

<div class="card">
  <label>Buscar cliente</label>
  <input id="busca" placeholder="Digite para buscar..." />

  <div class="busca-actions">
    <button onclick="buscar()">üîç Buscar</button>
    <button class="btn-secondary" onclick="limparBusca()">Limpar</button>
  </div>
</div>

<div id="resultado"></div>

<div class="install-banner" id="installBanner">
  <h3>üì≤ Instale o Medical Spin Dashboard</h3>
  <p>Acesse o sistema rapidamente sem abrir o navegador. Instale nosso app agora!</p>
  <div class="install-banner-actions">
    <button class="btn-install" onclick="installPWA()">Instalar Agora</button>
    <button class="btn-dismiss" onclick="dismissInstall()">Agora N√£o</button>
  </div>
</div>

<div class="success-animation" id="successAnimation">
  <div class="checkmark">‚úì</div>
  <h3>Sucesso!</h3>
  <p id="successMessage">Opera√ß√£o conclu√≠da com sucesso</p>
</div>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('[v0] Service Worker registered'))
      .catch(err => console.log('[v0] Service Worker registration failed:', err));
  });
}

const WEBHOOK_BUSCA = 'https://n8n-www4kggggc4c8k8ow4w8g4g0.95.217.164.173.sslip.io/webhook/autocomplete-edit-cliente';
const WEBHOOK_EDITA = 'https://n8n-www4kggggc4c8k8ow4w8g4g0.95.217.164.173.sslip.io/webhook/edita-cliente';
const WEBHOOK_OS = 'https://n8n-www4kggggc4c8k8ow4w8g4g0.95.217.164.173.sslip.io/webhook/autocomplete-os-history';

window.__clientes = [];
window.__equipamentosEdicao = [];
let chartClientes = null;
let chartEstados = null;

async function carregarGraficos() {
  try {
    const resClientes = await fetch(WEBHOOK_BUSCA, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ termo: '' })
    });
    const dataClientes = await resClientes.json();
    const clientes = dataClientes.resultados || [];

    const resOS = await fetch(WEBHOOK_OS, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ termo: '' })
    });
    const dataOS = await resOS.json();
    const listaOS = dataOS.os || [];

    document.getElementById('totalClientes').textContent = clientes.length;
    document.getElementById('totalOS').textContent = listaOS.length;

    calcularDistribuicaoClientes(clientes);
    calcularClientesPorEstado(clientes);

  } catch (error) {
    console.error('[v0] Erro ao carregar gr√°ficos:', error);
    document.getElementById('totalClientes').textContent = '0';
    document.getElementById('totalOS').textContent = '0';
  }
}

function calcularDistribuicaoClientes(clientes) {
  let ate1Equipamento = 0;
  let maisDe1Equipamento = 0;

  clientes.forEach(cliente => {
    const qtdEquipamentos = cliente.equipamentos ? cliente.equipamentos.length : 0;
    if (qtdEquipamentos <= 1) {
      ate1Equipamento++;
    } else {
      maisDe1Equipamento++;
    }
  });

  const ctx = document.getElementById('chartClientes');
  if (chartClientes) {
    chartClientes.destroy();
  }

  chartClientes = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['At√© 1 Equipamento', 'Mais de 1 Equipamento'],
      datasets: [{
        data: [ate1Equipamento, maisDe1Equipamento],
        backgroundColor: [
          '#0b74ff',
          '#10b981'
        ],
        borderWidth: 0,
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            font: {
              size: 13,
              weight: '600'
            },
            color: '#64748b',
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.9)',
          padding: 12,
          borderRadius: 8,
          titleColor: '#fff',
          bodyColor: '#fff',
          displayColors: true,
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
              return `${label}: ${value} (${percentage}%)`;
            }
          }
        }
      },
      cutout: '65%'
    }
  });
}

function calcularClientesPorEstado(clientes) {
  const estados = {};

  clientes.forEach(cliente => {
    const uf = cliente.uf || 'N√£o informado';
    estados[uf] = (estados[uf] || 0) + 1;
  });

  const estadosOrdenados = Object.entries(estados)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);

  const labels = estadosOrdenados.map(e => e[0]);
  const valores = estadosOrdenados.map(e => e[1]);

  const cores = [
    '#0b74ff', '#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe',
    '#dbeafe', '#0ea5e9', '#0284c7', '#0369a1', '#075985'
  ];

  const ctx = document.getElementById('chartEstados');
  if (chartEstados) {
    chartEstados.destroy();
  }

  chartEstados = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Clientes',
        data: valores,
        backgroundColor: cores,
        borderRadius: 8,
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.9)',
          padding: 12,
          borderRadius: 8,
          titleColor: '#fff',
          bodyColor: '#fff',
          displayColors: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            color: '#64748b',
            font: {
              size: 12
            }
          },
          grid: {
            color: '#e2e8f0',
            drawBorder: false
          }
        },
        x: {
          ticks: {
            color: '#64748b',
            font: {
              size: 12,
              weight: '600'
            }
          },
          grid: {
            display: false
          }
        }
      }
    }
  });
}

async function buscar() {
  const termo = document.getElementById('busca').value.trim().toLowerCase();
  const container = document.getElementById('resultado');
  container.innerHTML = '<div class="loading">Buscando</div>';

  try {
    const res = await fetch(WEBHOOK_BUSCA, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ termo })
    });

    const data = await res.json();
    let clientes = data.resultados || [];

    if (termo) {
      clientes = clientes.filter(c =>
        JSON.stringify(c).toLowerCase().includes(termo)
      );
    }

    renderizar(clientes);
  } catch (e) {
    container.innerHTML = '<p class="muted">Erro ao buscar</p>';
    console.error(e);
  }
}

function limparBusca() {
  document.getElementById('busca').value = '';
  buscar();
}

function renderizar(clientes) {
  const container = document.getElementById('resultado');
  container.innerHTML = '';

  if (!clientes.length) {
    container.innerHTML = '<p class="muted">Nenhum cliente encontrado</p>';
    return;
  }

  window.__clientes = clientes;

  clientes.forEach((c, i) => {
    const div = document.createElement('div');
    div.className = 'card';

    const equipamentos = (c.equipamentos || [])
      .map(e =>
        `<li>${e.tipo_equipamento} - ${e.fabricante} ${e.modelo} (${e.serie})</li>`
      )
      .join('') || '<li class="muted">Nenhum equipamento</li>';

    div.innerHTML = `
      <div class="cliente-header" onclick="toggleCliente(this)">
        <div>
          <strong style="font-size: 16px;">${c.nome_fantasia || c.razao_social}</strong><br>
          <span class="muted">
            ${c.cidade || ''}${c.uf ? ' - ' + c.uf : ''}
          </span><br>
          ${c.telefone ? `<span class="muted">üìû ${c.telefone}</span><br>` : ''}
          ${c.email ? `<span class="muted">‚úâÔ∏è ${c.email}</span>` : ''}
        </div>
        <span class="muted">ID ${c.id_cliente}</span>
      </div>

      <div class="cliente-body">
        <ul>${equipamentos}</ul>

        <div style="display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap;">
          <button onclick="editarCliente(${i})">
            ‚úèÔ∏è Editar Cliente
          </button>

          <a
            href="os.html?cliente=${c.id_cliente}"
            style="text-decoration:none;"
          >
            <button style="background: var(--success);">üìù Gerar OS</button>
          </a>
        </div>
      </div>
    `;

    container.appendChild(div);
  });
}

function toggleCliente(header) {
  header.closest('.card').classList.toggle('ativo');
}

function editarCliente(index) {
  const c = window.__clientes[index];

  document.getElementById('edit_id_cliente').value = c.id_cliente || '';
  document.getElementById('edit_razao_social').value = c.razao_social || '';
  document.getElementById('edit_nome_fantasia').value = c.nome_fantasia || '';
  document.getElementById('edit_cnpj').value = c.cnpj || '';
  document.getElementById('edit_cidade').value = c.cidade || '';
  document.getElementById('edit_uf').value = c.uf || '';
  document.getElementById('edit_telefone').value = c.telefone || '';
  document.getElementById('edit_email').value = c.email || '';
  document.getElementById('edit_responsavel').value = c.responsavel || '';

  window.__equipamentosEdicao = c.equipamentos || [];
  document.getElementById('modal').style.display = 'flex';
}

function fecharModal() {
  document.getElementById('modal').style.display = 'none';
}

async function salvarEdicao() {
  const payload = {
    evento: 'editar',
    id_cliente: document.getElementById('edit_id_cliente').value,
    razao_social: document.getElementById('edit_razao_social').value,
    nome_fantasia: document.getElementById('edit_nome_fantasia').value,
    cnpj: document.getElementById('edit_cnpj').value,
    cidade: document.getElementById('edit_cidade').value,
    uf: document.getElementById('edit_uf').value,
    telefone: document.getElementById('edit_telefone').value,
    email: document.getElementById('edit_email').value,
    responsavel: document.getElementById('edit_responsavel').value,
    equipamentos: window.__equipamentosEdicao
  };

  try {
    const res = await fetch(WEBHOOK_EDITA, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error();
    fecharModal();
    buscar();
    carregarGraficos();
    showSuccessAnimation('Cliente atualizado com sucesso!');
  } catch {
    alert('Erro ao salvar');
  }
}

async function deletarCliente() {
  if (!confirm('Deseja deletar este cliente?')) return;

  const payload = {
    evento: 'deletar',
    id_cliente: document.getElementById('edit_id_cliente').value,
    equipamentos: window.__equipamentosEdicao
  };

  await fetch(WEBHOOK_EDITA, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  fecharModal();
  buscar();
  carregarGraficos();
  showSuccessAnimation('Cliente deletado com sucesso!');
}

function adicionarCliente() {
  window.location.href = 'cliente.html';
}

function historicoOs() {
  window.location.href = 'historico.html';
}

function installPWA() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
      if (choiceResult.outcome === 'accepted') {
        showSuccessAnimation('App instalado com sucesso!');
      }
      deferredPrompt = null;
      installBanner.classList.remove('show');
    });
  }
}

function dismissInstall() {
  localStorage.setItem('installDismissed', Date.now().toString());
  installBanner.classList.remove('show');
}

function showSuccessAnimation(message) {
  const animation = document.getElementById('successAnimation');
  const messageEl = document.getElementById('successMessage');
  messageEl.textContent = message;
  animation.classList.add('show');
  
  setTimeout(() => {
    animation.classList.remove('show');
  }, 3000);
}

let deferredPrompt;
const installBanner = document.getElementById('installBanner');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  setTimeout(() => {
    const lastDismissed = localStorage.getItem('installDismissed');
    const daysSinceDismissed = lastDismissed ? 
      (Date.now() - parseInt(lastDismissed)) / (1000 * 60 * 60 * 24) : 999;
    
    if (daysSinceDismissed > 7) {
      installBanner.classList.add('show');
    }
  }, 3000);
});

document.addEventListener('DOMContentLoaded', () => {
  buscar();
  carregarGraficos();
});
</script>

<div id="modal">
  <div class="modal-content">
    <h3 style="margin-top: 0; color: var(--text-primary);">Editar Cliente</h3>

    <input type="hidden" id="edit_id_cliente" />

    <label>Raz√£o Social</label>
    <input id="edit_razao_social" />

    <label>Nome Fantasia</label>
    <input id="edit_nome_fantasia" />

    <label>CNPJ</label>
    <input id="edit_cnpj" />

    <label>Cidade</label>
    <input id="edit_cidade" />

    <label>UF</label>
    <input id="edit_uf" />

    <label>Telefone</label>
    <input id="edit_telefone" />

    <label>Email</label>
    <input id="edit_email" />

    <label>Respons√°vel</label>
    <input id="edit_responsavel" />

    <div style="display:flex;justify-content:space-between;gap:10px;margin-top:20px;flex-wrap:wrap;">
      <button onclick="deletarCliente()" style="background: var(--danger);">üóëÔ∏è Deletar</button>
      <div style="display:flex;gap:10px;">
        <button onclick="fecharModal()" class="btn-secondary">Cancelar</button>
        <button onclick="salvarEdicao()">üíæ Salvar</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
